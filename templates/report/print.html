{% load static %}
{% load custom_filters %}
<!doctype html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <title>Report {{ cabina.matricola }} - {{
        manutenzione.data_completamento|default:manutenzione.data_programmata|date:"d/m/Y" }}</title>
    <style>
        @page {
            size: A4 portrait;
            margin: 18mm 16mm 10mm 16mm;
            /* spazio per il footer */
        }

        /* Footer fisso, full-width su ogni pagina */
        #page-footer {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0mm;


            box-sizing: border-box;
            width: 100%;
            border-top: 0.6px solid #ddd;

            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;

            font-size: 9px;
            line-height: 1.4;
            color: #4a4a4a;
        }

        /* sinistra: logo + dati */
        #page-footer .left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        #page-footer .logo {
            height: 16px;
            width: auto;
            object-fit: contain;
            display: block;
        }

        #page-footer .company {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
        }

        #page-footer .company-name {
            font-weight: 700;
            text-transform: uppercase;
            color: #333;
        }

        #page-footer .company span+span::before {
            content: "•";
            margin: 0 4px;
            color: #999;
        }

        /* destra: contatti e paginazione */
        #page-footer .right {
            text-align: right;
            white-space: nowrap;
        }

        #page-footer .page-num::before {
            content: "Pagina " counter(page) " di " counter(pages);
            color: #6a6a6a;
            display: block;
            margin-top: 2px;
        }



        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 11.5px;
            line-height: 1.45;
            color: #222;
            counter-reset: sezioni;
            /* attiva contatore per sezioni */
        }

        /* Header fisso su ogni pagina */
        header#page-header {
            position: running(page-header);
            border-bottom: 1px solid #ddd;
            padding-bottom: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header#page-header .title {
            font-weight: 600;
            font-size: 13px;
            color: #333;
        }

        /* Copertina */
        .cover {
            page: cover;
            display: block;
            padding-top: 40mm;
            text-align: center;
            page-break-after: always;
            /* nuova pagina dopo */
        }

        .cover h1 {
            font-size: 28px;
            margin: 0 0 8px;
        }

        .cover .meta {
            font-size: 15px;
            color: #555;
            line-height: 1.6;
            margin-top: 4mm;
        }

        /* Titoli e sezioni */
        h1 {
            font-size: 18px;
            margin: 22px 0 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }

        h2 {
            font-size: 15px;
            margin: 18px 0 8px;
            color: #444;
        }

        .riepilogo-title {
            page-break-before: always;
            /* nuova pagina prima del riepilogo */
        }

        .section {
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            padding: 12px 14px;
            margin: 14px 0;
            background: #fcfcfc;
            page-break-inside: avoid;
            counter-increment: sezioni;
            /* conta ogni sezione */
            position: relative;
        }

        /* Numerazione automatica sezione */
        .section>h2::before {
            content: counter(sezioni) ". ";
            font-weight: 600;
            color: #444;
        }

        /* Tabelle chiave/valore */
        table.kv {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
        }

        table.kv td.label {
            width: 35%;
            background: #f7f7f7;
            font-weight: 600;
            color: #333;
            padding: 6px 8px;
            border: 1px solid #ddd;
        }

        table.kv td.value {
            width: 65%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        /* Note e testo grigio */
        .muted {
            color: #888;
            font-style: italic;
        }

        .nota {
            margin-top: 4px;
            font-size: 10px;
            color: #555;
            background: #f7f7f7;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* Immagini */
        .images {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        .images img {
            width: 160px;
            max-height: 120px;
            object-fit: cover;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 2px;
            background: #fff;
        }

        /* Firme */
        .signature-block {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            page-break-before: always;
            /* le firme vanno su nuova pagina */
        }

        .signature-block .muted {
            text-align: center;
            margin-bottom: 30px;
        }

        .sig {
            border-top: 1px solid #333;
            padding-top: 6px;
            text-align: center;
            height: 50px;
        }
    </style>
</head>

<body>
    <footer id="page-footer">
        <div class="left">
            <img class="logo" src="{% static 'img/logo.png' %}" alt="">
            <div class="company">
                <span class="company-name">AMON ENERGY SRL</span>
                <span>Sede legale: Castelluccio dei Sauri (FG) 71025 Via Basilio Leone 6</span>
                <span>Sede operativa: Troia (FG) 71029 Via Ludovico Ariosto n. 4</span>
                <span>P.IVA 03042590640 — Codice Univoco KRRH6B9</span>
            </div>
        </div>
        <div class="right">
            Tel: 0881372754<br>
            Mail: info@amonenergy.it<br>
            Pec: amonenergy@pec.it<br>
            
        </div>
    </footer>


    <!-- Header di pagina -->
    <header id="page-header">
        <div class="title">Report manutenzione — {{ cabina.nome }}</div>
    </header>

    <!-- Copertina -->
    <section class="cover">
        <h1>Report di Manutenzione</h1>
        <div class="meta">
            {{ cabina.matricola }} — {{ cabina.nome }}<br>
            Cliente: {{ cabina.cliente.nome_azienda }}<br>
            Data: {{ manutenzione.data_completamento|default:manutenzione.data_programmata|date:"d/m/Y" }}<br>
            Tipo: {{ manutenzione.get_tipo_display }}
        </div>
    </section>

    <!-- Riepilogo -->
    <h1 class="riepilogo-title">Riepilogo</h1>
    <table class="kv">
        <tr>
            <td class="label">Esito</td>
            <td class="value">{{ report.esito|default:"Completato" }}</td>
        </tr>
        <tr>
            <td class="label">Note</td>
            <td class="value">
                {% if report.note %}{{ report.note }}{% else %}<span class="muted">Nessuna nota</span>{% endif %}
            </td>
        </tr>
    </table>

    <!-- Sezioni dinamiche -->
    {% for sec in schema.sections %}
    <div class="section">
        {% if sec.title %}<h2>{{ sec.title }}</h2>{% endif %}
        {% for it in sec.items %}
        {% with val=dati|get_item:it.name %}
        {% if it.type == "image" %}
        <div class="item">
            <div class="muted">{{ it.label|default:it.name }}</div>
            <div class="images">
                {% for url in attachments|get_item:it.name %}
                <img src="{{ url }}" alt="{{ it.label|default:it.name }}">
                {% empty %}
                {% if val %}
                {% for v in val %}
                <img src="{{ v }}" alt="{{ it.label|default:it.name }}">
                {% endfor %}
                {% else %}
                <div class="muted">—</div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% else %}
        <table class="kv">
            <tr>
                <td class="label">{{ it.label|default:it.name }}</td>
                <td class="value">
                    {% if val is not None and val != "" %}
                    {% if it.type == "bool" %}
                    {% if val %}
                    <strong>ESEGUITO</strong>
                    {% else %}
                    <span style="color: red;"><strong>NON ESEGUITO</strong></span>
                    {% endif %}
                    {% else %}
                    {{ val }}
                    {% endif %}
                    {% else %}
                    <span class="muted">—</span>
                    {% endif %}

                    {% with note_key=it.name|add:"__note" %}
                    {% with nota=dati|get_item:note_key %}
                    {% if nota %}
                    <div class="nota">Nota: {{ nota }}</div>
                    {% endif %}
                    {% endwith %}
                    {% endwith %}
                </td>
            </tr>
        </table>
        {% endif %}
        {% endwith %}
        {% endfor %}
    </div>
    {% endfor %}
</body>


</html>