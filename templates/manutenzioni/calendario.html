{% extends "base.html" %} {% block content %}

<div class="max-w-7xl mx-auto px-4 pt-6 grid grid-cols-1 md:grid-cols-4 gap-6">
  <!-- COLONNA SINISTRA -->
  <aside class="md:col-span-1 bg-white shadow rounded-2xl p-4 space-y-4">
    <h2 class="text-lg font-semibold text-gray-800">ðŸ”´ Manutenzioni scadute</h2>
    <ul id="lista-scadute" class="space-y-2 text-sm text-gray-700"></ul>
  </aside>

  <!-- COLONNA DESTRA -->
  <section class="md:col-span-3 bg-white shadow rounded-2xl p-4 space-y-4">
    <!-- FILTRI -->
    <div class="flex flex-wrap items-center gap-3">
      <label class="flex items-center gap-1">
        <input type="checkbox" class="filtro-tipo" value="annuale" checked />
        <span class="w-3 h-3 rounded bg-green-500"></span>
        <span class="text-sm">Annuale</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="filtro-tipo" value="semestrale" checked />
        <span class="w-3 h-3 rounded bg-blue-500"></span>
        <span class="text-sm">Semestrale</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="filtro-tipo" value="mensile" checked />
        <span class="w-3 h-3 rounded bg-yellow-500"></span>
        <span class="text-sm">Mensile</span>
      </label>
      <label class="flex items-center gap-1">
        <input type="checkbox" class="filtro-tipo" value="spot" checked />
        <span class="w-3 h-3 rounded bg-purple-500"></span>
        <span class="text-sm">Spot</span>
      </label>
    </div>

    <div id="calendar"></div>
  </section>
</div>

<!-- MODAL -->
<div
  id="modal-giorno"
  class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
>
  <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6 space-y-4">
    <div class="flex justify-between items-center">
      <h3 id="modal-data" class="text-lg font-semibold text-gray-800"></h3>
      <button id="modal-close" class="text-gray-500 hover:text-gray-800">
        &times;
      </button>
    </div>
    <ul id="modal-lista" class="space-y-2 text-sm text-gray-700"></ul>
  </div>
</div>

<style>
  #calendar .fc-event {
    border-radius: 6px;
    padding: 2px 4px;
    font-size: 0.8rem;
    font-weight: 500;
  }
  #calendar .fc-daygrid-day-frame {
    padding: 2px;
  }
  .fc-daygrid-day.has-noncompletate {
    background-color: #f9fafb !important;
  }
  #calendar .fc-day-today {
    background-color: #ecfdf5 !important; /* verde chiarissimo */
    border: 2px solid #10b981 !important; /* verde tailwind */
    border-radius: 6px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const listaScadute = document.getElementById("lista-scadute");
    const calendarEl = document.getElementById("calendar");

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: "it",
      firstDay: 1,
      height: "auto",
      aspectRatio: 1.3,
      headerToolbar: { left: "prev,next today", center: "title", right: "" },
      events: '{% url "calendario_manutenzioni" %}',

      eventClassNames: function (arg) {
        const tipo = arg.event.extendedProps.tipo;
        if (tipo === "annuale") return ["bg-green-500", "text-white"];
        if (tipo === "semestrale") return ["bg-blue-500", "text-white"];
        if (tipo === "mensile") return ["bg-yellow-500", "text-black"];
        if (tipo === "spot") return ["bg-purple-500", "text-white"];
      },

      eventsSet: function (events) {
        const formatter = new Intl.DateTimeFormat("it-IT", {
          day: "2-digit",
          month: "long",
          year: "numeric",
        });

        listaScadute.innerHTML = "";
        const oggi = new Date().toISOString().split("T")[0];

        events.forEach((e) => {
          if (e.startStr < oggi) {
            const dataFormattata = formatter.format(new Date(e.startStr));
            listaScadute.innerHTML += `
      <li class="border-l-4 border-red-500 pl-2">
        <strong>${e.title}</strong><br>
        <span class="text-xs text-gray-500">${dataFormattata}</span>
      </li>`;
          }
        });

        // --- Celle calendario ---
        setTimeout(() => {
          document.querySelectorAll(".fc-daygrid-day").forEach((dayCell) => {
            const date = dayCell.dataset.date;
            const eventi = eventiPerGiorno[date] || [];
            const count = eventi.length;

            dayCell.classList.toggle("has-noncompletate", count > 0);
            dayCell.querySelectorAll(".day-label").forEach((l) => l.remove());

            if (count === 1) {
              const lbl = creaLabel(eventi[0]);
              dayCell.appendChild(lbl);
            } else if (count > 1) {
              const badge = document.createElement("span");
              badge.className =
                "day-label absolute top-1 right-1 bg-gray-700 text-white text-xs px-1.5 py-0.5 rounded-full cursor-pointer";
              badge.textContent = `+${count}`;
              badge.onclick = () => apriModal(date, eventi);
              dayCell.style.position = "relative";
              dayCell.appendChild(badge);

              if (count <= 4) {
                eventi.forEach((e) => dayCell.appendChild(creaLabel(e)));
              }
            }
          });
        }, 50);
      },
    });

    calendar.render();

    document.querySelectorAll(".filtro-tipo").forEach((cb) => {
      cb.addEventListener("change", function () {
        const attivi = Array.from(
          document.querySelectorAll(".filtro-tipo:checked")
        ).map((c) => c.value);
        calendar.getEvents().forEach((ev) => {
          ev.setProp(
            "display",
            attivi.includes(ev.extendedProps.tipo) ? "auto" : "none"
          );
        });
      });
    });

    function creaLabel(e) {
      const colorMap = {
        annuale: "bg-green-100 text-green-800",
        semestrale: "bg-blue-100 text-blue-800",
        mensile: "bg-yellow-100 text-yellow-800",
        spot: "bg-purple-100 text-purple-800",
      };
      const lbl = document.createElement("div");
      lbl.className = `day-label block text-[10px] truncate mt-0.5 px-1 rounded cursor-pointer ${
        colorMap[e.extendedProps.tipo] || "bg-gray-100 text-gray-800"
      }`;
      lbl.textContent = e.title;
      lbl.onclick = () => (window.location.href = e.url);
      dayCell.style.position = "relative";
      return lbl;
    }

    function apriModal(data, eventi) {
      document.getElementById(
        "modal-data"
      ).textContent = `Manutenzioni del ${data}`;
      const lista = document.getElementById("modal-lista");
      lista.innerHTML = "";
      eventi.forEach((ev) => {
        lista.innerHTML += `
        <li class="border-l-4 border-primary pl-2">
          <a href="${ev.url}" class="text-primary hover:underline font-medium">${ev.title}</a>
          <span class="block text-xs text-gray-500 capitalize">${ev.extendedProps.tipo}</span>
        </li>`;
      });
      document.getElementById("modal-giorno").classList.remove("hidden");
    }

    document.getElementById("modal-close").onclick = () =>
      document.getElementById("modal-giorno").classList.add("hidden");
    document.getElementById("modal-giorno").onclick = (e) => {
      if (e.target.id === "modal-giorno")
        e.currentTarget.classList.add("hidden");
    };
  });
</script>

{% endblock %}
