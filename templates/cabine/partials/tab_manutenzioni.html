<div class="bg-white shadow-lg rounded-lg p-6 mb-8">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Stato Manutenzione Ordinaria</h2>
    <div class="flex items-center justify-between">
        <div class="flex items-center">
            <div class="w-4 h-4 rounded-full mr-3
                    {% if stato_ordinaria == 'ok' %}bg-green-500
                    {% elif stato_ordinaria == 'in_scadenza' %}bg-yellow-500
                    {% else %}bg-red-500{% endif %}">
            </div>
            <span class="text-lg font-medium
                    {% if stato_ordinaria == 'ok' %}text-green-700
                    {% elif stato_ordinaria == 'in_scadenza' %}text-yellow-700
                    {% else %}text-red-700{% endif %}">
                {% if stato_ordinaria == 'ok' %}‚úÖ OK
                {% elif stato_ordinaria == 'in_scadenza' %}‚ö†Ô∏è In Scadenza
                {% elif stato_ordinaria == 'nessuna_programmata' %}üìã Nessuna Programmata
                {% else %}üö® Scaduta{% endif %}
            </span>
        </div>
        <div class="text-right">
            {% if prossima_ordinaria %}
            <div class="text-sm text-gray-600">Prossima Manutenzione:</div>
            <div class="font-bold
                    {% if stato_ordinaria == 'ok' %}text-green-700
                    {% elif stato_ordinaria == 'in_scadenza' %}text-yellow-700
                    {% else %}text-red-700{% endif %}">
                {{ prossima_ordinaria|date:"d/m/Y" }}
                {% if giorni_ordinaria %}
                <span class="text-sm">
                    {% if giorni_ordinaria < 0 %}( {{ giorni_ordinaria }} giorni ){% endif %}
                </span>
                {% endif %}
            </div>
            {% else %}
            <div class="text-sm text-gray-600">Nessuna manutenzione programmata</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Manutenzioni Programmate -->
<div class="bg-white shadow-lg rounded-lg p-6 mb-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Manutenzioni</h2>
        {% if user.is_administrator or user.is_controlroom %}
        <div class="flex space-x-2">
            <a href="{% url 'programma_manutenzione' cabina.matricola %}"
                class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded text-sm">
                üìÖ Nuova manutenzione
            </a>
        </div>
        {% endif %}
    </div>

    {% if cabina.manutenzioni.all %}
    <div class="space-y-3">
        {% for manutenzione in cabina.manutenzioni.all|slice:":5" %}
        <div
            class="border rounded-lg p-4 {% if manutenzione.stato_scadenza == 'scaduta' %}border-red-300 bg-red-50{% elif manutenzione.stato_scadenza == 'urgente' %}border-orange-300 bg-orange-50{% elif manutenzione.stato_scadenza == 'in_scadenza' %}border-yellow-300 bg-yellow-50{% else %}border-gray-300{% endif %}">
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center space-x-2">
                        <span class="font-medium">{{ manutenzione.get_tipo_display }}</span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium
        {% if manutenzione.stato == 'programmata' %}bg-blue-100 text-blue-800
        {% elif manutenzione.stato == 'in_corso' %}bg-yellow-100 text-yellow-800
        {% elif manutenzione.stato == 'completata' %}bg-green-100 text-green-800
        {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ manutenzione.get_stato_display }}
                        </span>
                        {% if manutenzione.stato == 'completata'%}
                            <span class="px-2 py-1 rounded-full text-xs font-medium
            {% if manutenzione.report.stato == 'bozza' %}bg-blue-100 text-blue-800
            {% elif manutenzione.stato == 'inviato' %}bg-green-100 text-green-800
            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                Report {{ manutenzione.report.stato }}
                            </span>
                        {%endif%}
                        {% if user.is_administrator or user.is_controlroom %}
                        {% if manutenzione.stato != 'completata' %}
                        <a href="{% url 'modifica_manutenzione' manutenzione.id %}"
                            class="text-blue-600 hover:text-blue-900 text-xs">
                            ‚úèÔ∏è Modifica
                        </a>
                        {% endif %}
                        {% endif %}
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        <strong>Data:</strong> {{ manutenzione.data_programmata|date:"d/m/Y" }}
                        {% if manutenzione.data_completamento %}
                        | <strong>Completata:</strong> {{ manutenzione.data_completamento|date:"d/m/Y" }}
                        {% endif %}
                        {% if manutenzione.operatore %}
                        | <strong>Operatore:</strong> {{ manutenzione.operatore.username }}
                        {% endif %}
                    </div>
                    {% if manutenzione.note %}
                    <div class="text-sm text-gray-600 mt-1">{{ manutenzione.note|truncatechars:100 }}</div>
                    {% endif %}
                </div>
                <div class="text-right">
                    {% if manutenzione.stato != 'completata' and manutenzione.giorni_alla_scadenza is not None %}
                    <div class="text-sm font-medium
                                {% if manutenzione.stato_scadenza == 'scaduta' %}text-red-600
                                {% elif manutenzione.stato_scadenza == 'urgente' %}text-orange-600
                                {% elif manutenzione.stato_scadenza == 'in_scadenza' %}text-yellow-600
                                {% else %}text-green-600{% endif %}">
                        {% if manutenzione.giorni_alla_scadenza > 0 %}
                        tra {{ manutenzione.giorni_alla_scadenza }} giorni
                        {% elif manutenzione.giorni_alla_scadenza == 0 %}
                        oggi
                        {% else %}
                        {{ manutenzione.giorni_alla_scadenza|add:"0"|floatformat:"0" }} giorni fa
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if user.is_administrator or user.is_controlroom %}
                    {% if manutenzione.stato != 'completata' %}
                    <form method="post" action="{% url 'completa_manutenzione' manutenzione.id %}" class="inline">
                        {% csrf_token %}
                        <label for="data_completamento" class="text-xs text-gray-700">
                            Data completamento (opzionale)
                        </label>
                        <input type="date" id="data_completamento" name="data_completamento" value="{% now 'Y-m-d' %}"
                            class="border rounded px-2 py-1 text-xs" />
                        <button type="submit"
                            class="bg-green-500 hover:bg-green-700 text-white font-bold mt-4 py-2 px-3 rounded text-xs">
                            ‚úÖ Completa manutenzione
                        </button>
                    </form>
                    {% endif %}
                    {% endif %}

                    {% if manutenzione.stato == 'completata' %}
                    
                    
                        <a href="{% url 'report_compila' manutenzione.pk %}"
                            class="bg-blue-500 hover:bg-blue-400 text-white font-bold mt-4 py-2 px-3 rounded text-xs">
                            ‚úçÔ∏è Report {{ manutenzione.report.stato }}
                        </a>
                    
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-8 text-gray-500">
        <p>Nessuna manutenzione programmata</p>
    </div>
    {% endif %}
</div>