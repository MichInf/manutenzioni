<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<style>[x-cloak]{display:none!important}</style>

<div x-data="serviziForm({{ servizi_initial|safe|default:'[]' }})" class="mt-8">
  <h2 class="text-xl font-semibold text-gray-700">Servizi Associati</h2>

  <div class="flex justify-between">
    <button type="button" @click="add" class="mt-4 bg-green-600 text-white px-4 py-2 rounded">
      Aggiungi un servizio alla cabina
    </button>
  </div>

  <template x-for="(item, index) in servizi" :key="item.uid">
    <div class="grid grid-cols-2 gap-4 border p-4 rounded bg-gray-50 relative mt-4">
      <button type="button" class="absolute top-2 right-2 text-red-600" @click="remove(index)">✖</button>

      <div class="flex items-end gap-2">
        <div class="w-full">
          <label class="block text-sm font-medium text-gray-700 mb-1">Servizio</label>
          <select :name="`servizio[]`"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 bg-white text-gray-900"
                  x-model.number="item.servizio">
            <option value="">— seleziona —</option>
            {% for s in servizi_options %}
              <option value="{{ s.id }}">{{ s.nome }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Scadenza</label>
        <input type="date"
               :name="`scadenza[]`"
               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 bg-white text-gray-900"
               :min="'{{ today|date:'Y-m-d' }}'"
               x-model="item.scadenza" />
      </div>
    </div>
  </template>

  {# Se vuoi, mostra “nessun servizio” #}
  <div x-show="servizi.length === 0" x-cloak class="text-gray-500 mt-3 text-sm">
    Nessun servizio aggiunto.
  </div>
</div>

<script>
  function serviziForm(initial){
    const norm = (Array.isArray(initial) ? initial : []);
    return {
      servizi: norm.map((x, i) => ({
        uid: crypto?.randomUUID ? crypto.randomUUID() : ('uid_'+i+'_'+Date.now()),
        servizio: x.servizio || '',
        scadenza: x.scadenza || '',
      })),
      add(){
        this.servizi.push({
          uid: crypto?.randomUUID ? crypto.randomUUID() : ('uid_'+Math.random()),
          servizio: '',
          scadenza: '',
        });
      },
      remove(i){ this.servizi.splice(i,1); },
    }
  }
</script>
