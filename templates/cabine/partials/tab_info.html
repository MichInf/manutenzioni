<section class="bg-white shadow rounded-2xl p-4 md:p-6 relative">

  <!-- Header -->
  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
    <div class="min-w-0">
      <h1 class="text-2xl md:text-4xl font-bold text-gray-800 break-all">{{ cabina.matricola }}</h1>
      <p class="text-gray-600 text-base md:text-lg truncate">{{ cabina.nome }}</p>
    </div>

    <div class="flex items-center gap-2">
      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs md:text-sm font-medium
                   {% if cabina.attiva %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
        {% if cabina.attiva %}Attiva{% else %}Inattiva{% endif %}
      </span>

      {% if user.is_administrator or user.is_controlroom %}
      <!-- Bottone desktop -->
      <a href="{% url 'modifica_cabina' cabina.matricola %}"
         class="hidden md:inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700
                text-white font-semibold px-4 py-2 rounded-lg shadow-sm">
        ‚úèÔ∏è Modifica Cabina
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Cliente / GPS -->
  <div class="mt-3 space-y-2 text-gray-700">
    {% if cabina.latitudine and cabina.longitudine %}
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
      </svg>
      <span class="truncate">
        GPS: {{ cabina.latitudine|floatformat:6 }}, {{ cabina.longitudine|floatformat:6 }}
      </span>
    </div>
    {% endif %}

    {% if cabina.cliente %}
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
      </svg>
      <span class="truncate">Cliente: {{ cabina.cliente.nome_azienda }}</span>
    </div>
    {% endif %}
  </div>

  <!-- Griglia: 1 colonna su mobile, 2 su md+ -->
  <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-800">

    <!-- Colonna sinistra: info tecniche -->
    <div class="space-y-2">
      {% if cabina.fonte %}<div><span class="font-semibold">Fonte:</span> {{ cabina.fonte }}</div>{% endif %}
      {% if cabina.societa_proprietaria %}<div><span class="font-semibold">Societ√† proprietaria:</span> {{ cabina.societa_proprietaria }}</div>{% endif %}
      {% if cabina.guardiania %}<div><span class="font-semibold">Guardiania:</span> {{ cabina.guardiania }}</div>{% endif %}
      {% if cabina.telefono_guardiania %}<div><span class="font-semibold">Tel. Guardiania:</span> {{ cabina.telefono_guardiania }}</div>{% endif %}
      {% if cabina.chiave %}<div><span class="font-semibold">Chiave:</span> {{ cabina.chiave }}</div>{% endif %}
      {% if cabina.pod %}<div class="break-all"><span class="font-semibold">POD:</span> {{ cabina.pod }}</div>{% endif %}
    </div>

    <!-- Colonna destra: servizi -->
    <div class="md:pl-2">
      <h3 class="text-base font-semibold text-gray-900 mb-2">Servizi attivi</h3>

      <ul class="rounded-lg border divide-y">
        {% for cs in cabina.servizi_assoc.all %}
        <li class="p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2"
            x-data="{ open:false }" @keydown.escape.window="open=false">
          <div class="min-w-0">
            <div class="font-medium {% if cs.scadenza <= today %}text-red-600{% else %}text-gray-900{% endif %} truncate">
              {{ cs.servizio.nome }}
            </div>
            {% if cs.scadenza > today %}
              <div class="text-gray-600">scade il {{ cs.scadenza|date:"d/m/Y" }}</div>
            {% else %}
              <div class="text-red-600">scaduto il {{ cs.scadenza|date:"d/m/Y" }}</div>
            {% endif %}
          </div>

          {% if cs.scadenza <= today %}
          <button type="button"
                  class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded"
                  @click="open=true">
            üîÑ Rinnova
          </button>
          {% endif %}

          <!-- Modale rinnovo -->
          <div x-cloak x-show="open" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center">
            <div class="absolute inset-0 bg-black/50" @click="open=false"></div>
            <div class="relative z-10 w-[92%] max-w-md rounded-lg bg-white p-6 shadow-lg" @click.outside="open=false">
              <h3 class="text-lg font-semibold mb-4">Imposta nuova data di scadenza</h3>
              <form method="post" action="{% url 'rinnova_servizio' cs.id %}">
                {% csrf_token %}
                <label for="new_date_{{ cs.id }}" class="block text-sm text-gray-700 mb-1">Nuova scadenza</label>
                <input id="new_date_{{ cs.id }}" name="new_date" type="date"
                       class="border rounded px-3 py-2 w-full mb-4"
                       min="{{ today|date:'Y-m-d' }}"
                       value="{% if cs.scadenza and cs.scadenza > today %}{{ cs.scadenza|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}">
                <div class="flex flex-col sm:flex-row justify-end gap-2">
                  <button type="button" class="px-4 py-2 rounded border" @click="open=false">Annulla</button>
                  <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Salva</button>
                </div>
              </form>
            </div>
          </div>
        </li>
        {% empty %}
          <li class="p-3 text-gray-500">Nessun servizio attivo.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
</section>

{% if cabina.note %}
<section class="bg-white shadow rounded-2xl p-4 md:p-6 mt-4">
  <h3 class="text-base md:text-lg font-semibold text-gray-900 mb-2">Note</h3>
  <p class="text-gray-700 whitespace-pre-line break-words">{{ cabina.note }}</p>
</section>
{% endif %}

<!-- Azione flottante su mobile -->
{% if user.is_administrator or user.is_controlroom %}
<a href="{% url 'modifica_cabina' cabina.matricola %}"
   class="md:hidden fixed bottom-5 right-5 z-40 inline-flex items-center gap-2
          bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-3
          rounded-full shadow-lg">
  ‚úèÔ∏è Modifica Cabina
</a>
{% endif %}
